<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stationenlauf DHBW Heidenheim Ersti-Tage</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        html, body { margin:0; padding:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
        #map { position: fixed; inset: 0; }

        /* Topbar responsive + wraps */
        .topbar {
            position: fixed;
            top: 8px;
            left: 8px;
            right: 8px;
            background: rgba(255,255,255,0.95);
            padding: 6px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
            z-index: 1000;
        }
        .badge { font-size: 12px; background:#f2f4f7; padding:3px 6px; border-radius:999px; }
        .actions { position: static; margin-left: auto; }
        .actions button {
            border: none; padding: 6px 10px; border-radius: 10px; background: white; cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.12);
            font-size: 13px;
        }

        /* Popups Standorte */
        .popup-wrap { min-width: 200px; max-width: 280px; font-size: 13px; }
        .popup-title { display:flex; justify-content:space-between; align-items:center; gap:6px; margin-bottom:4px; }
        .popup-desc { font-size: 12px; color:#6b7280; margin-bottom:8px; }
        .task { display:grid; gap:4px; margin-bottom:8px; padding:6px; background:#fafafa; border:1px solid #e5e7eb; border-radius:8px; }
        .row { display:flex; gap:4px; }
        .task input[type="text"]{ flex:1; padding:6px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; }
        .task button{ padding:6px 8px; border:none; border-radius:6px; background:#2563eb; color:white; cursor:pointer; font-size:13px; }
        .task button[disabled]{ background:#9ca3af; cursor:default; }
        .ok { color:#15803d; font-weight:600; }
        .err { color:#b91c1c; font-size:12px; }
        .done-line { margin-top:4px; color:#15803d; font-weight:600; }
        .hint { font-size:11px; color:#6b7280; }

        @media (max-width: 480px) {
            .topbar strong { font-size: 13px; }
            .badge { font-size: 11px; }
            .popup-wrap { max-width: 92vw; min-width: 70vw; font-size: 12px; }
        }
    </style>
</head>
<body>
<div class="topbar">
    <strong>Stationenlauf DHBW Heidenheim Ersti-Tage</strong>
    <span id="progressBadge" class="badge">0/0 Aufgaben erledigt</span>
    <div class="actions">
        <button id="resetBtn">Fortschritt zurücksetzen</button>
    </div>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // ===================== STATIONEN =====================
  const STATIONS = [
    {
      id: "s1",
      name: "DHBW Würfel – Marienstraße 20",
      lat: 48.68186956433014,
      lng: 10.154709643897347,
      description: "Finde den DHBW Würfel und löse alle Aufgaben.",
      tasks: [
        { id:"t1", label:"StuV Raum - EG M003", codePlain:"1111" },
        { id:"t2", label:"International Office - 7.OG M718", codePlain:"1111" },
        { id:"t3", label:"Nachhaltigkeit - EG Eingangshalle", codePlain:"1111" },
        { id:"t4", label:"Studierndenwerk Ulm - EG Eingangshalle", codePlain:"1111" },
        { id:"t5", label:"DHBW Hauptbibliothek - 4.OG M406", codePlain:"1111" },
        { id:"t6", label:"DHBW Studienberatung - 7.OG M729", codePlain:"1111" },
        { id:"t7", label:"Ersti-Geschenk - 2.OG M203", codePlain:"1111" }
      ]
    },
    {
      id: "s2",
      name: "Felsen Bar",
      lat: 48.68392021671733,
      lng: 10.154129832887437,
      description: "Löse die Aufgabe an der Felsen Bar.",
      tasks: [
        { id:"t1", label:"Refresher", codePlain:"1111" }
      ]
    },
    {
      id: "s3",
      name: "Brenzpark – Eingang über Drehtor beim Badehaus",
      lat: 48.684673587174395,
      lng: 10.155108700381763,
      description: "Am Eingang zum Brenzpark erwarten dich 3 Aufgaben.",
      tasks: [
        { id:"t1", label:"StuV Bier-Pong - weißes Badehaus", codePlain:"1111" },
        { id:"t2", label:"StuV Yoga - Cafe Lieblingsplatz", codePlain:"1111" },
        { id:"t3", label:"StuV Sport im Park - Rutschenturm", codePlain:"1111" }
      ]
    },
    {
      id: "s4",
      name: "DHBW Digitalcampus – Hanns-Voith-Campus 1",
      lat: 48.68396562127026,
      lng: 10.155880680689945,
      description: "Löse alle 5 Aufgaben am Digitalcampus.",
      tasks: [
        { id:"t2", label:"IG Metall - EG (Aula)", codePlain:"1111" },
        { id:"t3", label:"StuV Wünsch dir was - EG (Aula)", codePlain:"1111" },
        { id:"t4", label:"Stuv Speeddating - Dachterasse", codePlain:"1111" },
        { id:"t5", label:"Stadt Heidenheim - EG (Aula)", codePlain:"1111" },
        { id:"t6", label:"Kulturbündnis", codePlain:"1111" }
      ]
    }
  ];

  const MAP_CENTER = [48.6835, 10.1550]; //Startmittelpunkt der Karte
  const STORAGE_KEY = "rallye_popup_v1"; //Schlüssel, unter dem der Nutzer-Fortschritt im localStorage gespeichert wird

  // ===================== UTIL: SHA-256 =====================
  async function sha256hex(text) { // wandelt einen String in einen SHA-256-Hex-Hash um im Browser über crypto.subtle
    const data = new TextEncoder().encode(text);
    const digest = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  async function ensureHashes() { //iteriert über alle Aufgaben und berechnet, falls kein codeHash vorhanden ist, berechnet er diesen aus codePlain und hängt ihn an die Aufgabe
    for (const st of STATIONS) {
      for (const task of st.tasks) {
        if (!task.codeHash && task.codePlain != null) {
          task.codeHash = await sha256hex(String(task.codePlain));
        }
      }
    }
  }

  // ===================== STORAGE ===================== Fortschritt geräte-/Browsergebunden speichern -> Hinweis im Popup
  function readProgress() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }
  function writeProgress(p) { localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }
  function isDone(stationId, taskId) {
    const p = readProgress();
    return !!(p[stationId] && p[stationId][taskId]);
  }
  function setDone(stationId, taskId) {
    const p = readProgress();
    if (!p[stationId]) p[stationId] = {};
    p[stationId][taskId] = true;
    writeProgress(p);
  }
  function stationFinished(station) {
    const p = readProgress();
    const s = p[station.id] || {};
    return station.tasks.every(t => s[t.id]);
  }

  // ===================== openstreet MAP ===================== Leaflet
  const map = L.map('map').setView(MAP_CENTER, 17);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap-Mitwirkende'
  }).addTo(map);

  function markerStyle(done) {
    return {
      radius: 10,
      color: done ? "#15803d" : "#2563eb",
      weight: 2,
      fillColor: done ? "#86efac" : "#93c5fd",
      fillOpacity: 0.9
    };
  }

  const markers = new Map();

  function updateProgressBadge() {
    let total = 0;
    let done = 0;
    const p = readProgress();
    for (const st of STATIONS) {
      total += st.tasks.length;
      for (const t of st.tasks) {
        if (p[st.id] && p[st.id][t.id]) done++;
      }
    }
    document.getElementById("progressBadge").textContent =
      `${done}/${total} Aufgaben erledigt`;
  }

  function rebuildPopup(station, circle) {
    const wrap = document.createElement("div");
    wrap.className = "popup-wrap";

    const head = document.createElement("div");
    head.className = "popup-title";
    const title = document.createElement("strong");
    title.textContent = station.name + (stationFinished(station) ? " ✅" : "");
    const idspan = document.createElement("span");
    idspan.className = "hint";
    idspan.textContent = `ID: ${station.id}`;
    head.appendChild(title);
    head.appendChild(idspan);

    const desc = document.createElement("div");
    desc.className = "popup-desc";
    desc.textContent = station.description || "";

    wrap.appendChild(head);
    wrap.appendChild(desc);

    station.tasks.forEach((task, idx) => {
      const taskBox = document.createElement("div");
      taskBox.className = "task";

      const label = document.createElement("div");
      label.textContent = `${task.label || ("Aufgabe " + (idx+1))}`;
      taskBox.appendChild(label);

      const msg = document.createElement("div");
      taskBox.appendChild(msg);

      const row = document.createElement("div");
      row.className = "row";

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Zahlencode";
      input.inputMode = "numeric";
      input.pattern = "\\d*";

      const btn = document.createElement("button");
      btn.textContent = "Prüfen";

      async function verify() {
        const v = (input.value || "").trim();
        if (!/^\d+$/.test(v)) { msg.textContent = "Bitte nur Ziffern eingeben."; msg.className = "err"; return; }
        const hex = await sha256hex(v);
        if (hex === task.codeHash) {
          setDone(station.id, task.id);
          msg.textContent = "Richtig! ✅"; msg.className = "ok";
          input.disabled = true; btn.disabled = true;
          if (stationFinished(station)) {
            title.textContent = station.name + " ✅";
            circle.setStyle(markerStyle(true));
            const doneLine = document.createElement("div");
            doneLine.className = "done-line";
            doneLine.textContent = "Alle Aufgaben erledigt! ✓";
            wrap.appendChild(doneLine);
            updateProgressBadge();
          } else {
            updateProgressBadge();
          }
        } else {
          msg.textContent = "Leider falsch – nochmal versuchen.";
          msg.className = "err";
        }
      }

      btn.addEventListener("click", verify);
      input.addEventListener("keydown", (e) => { if (e.key === "Enter") verify(); });

      if (isDone(station.id, task.id)) {
        msg.textContent = "Bereits erledigt ✅"; msg.className = "ok";
        input.disabled = true; btn.disabled = true;
      }

      row.appendChild(input);
      row.appendChild(btn);
      taskBox.appendChild(row);
      wrap.appendChild(taskBox);
    });

    if (stationFinished(station)) {
      const doneLine = document.createElement("div");
      doneLine.className = "done-line";
      doneLine.textContent = "Alle Aufgaben erledigt! ✓";
      wrap.appendChild(doneLine);
    } else {
      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "Hinweis: Fortschritt ist an dieses Gerät/Browser gebunden.";
      wrap.appendChild(hint);
    }

    return wrap;
  }

  async function init() {
    await ensureHashes();

    for (const st of STATIONS) {
      const circle = L.circleMarker([st.lat, st.lng], markerStyle(stationFinished(st))).addTo(map);
      circle.bindTooltip(st.name, { direction:"top" });
      circle.on("click", () => {
        const content = rebuildPopup(st, circle);
        circle.bindPopup(content).openPopup();
      });
      markers.set(st.id, circle);
    }

    updateProgressBadge();
  }

  init();

  // --- [A] Reset-Button Handler ---
  function resetProgress() {
    if (!confirm("Fortschritt auf diesem Gerät wirklich löschen?")) return;
    localStorage.removeItem(STORAGE_KEY);
    for (const st of STATIONS) {
      const m = markers.get(st.id);
      if (m) m.setStyle(markerStyle(false));
    }
    updateProgressBadge();
    map.closePopup();
    alert("Fortschritt gelöscht.");
  }

  document.getElementById("resetBtn").addEventListener("click", resetProgress);
</script>
</body>
</html>
